<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalRank Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Inter:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
            background-color: #FFFCF9;
            color: #2D3748;
        }
        h1, h2, h3, h4, .font-display {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
        }
        .gradient-text {
            background: linear-gradient(90deg, #F18B25, #C20F0A);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-primary {
            background-color: #F18B25;
        }
        .btn-primary:hover {
            background-color: #d87a1f;
        }
        .ring-primary {
            ring-color: #F18B25;
        }
        .bg-secondary-light {
            background-color: #47b7d420;
        }
        .text-secondary {
             color: #47B7D4;
        }
        .btn-secondary {
            background-color: #47B7D4;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #3aa9c4;
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .text-lifted {
            text-shadow: 2px 2px 5px rgba(45, 55, 72, 0.2);
        }
    </style>
</head>
<body class="antialiased">
    <div id="app" class="min-h-screen flex flex-col md:flex-row">
        <!-- Sidebar Navigation -->
        <aside class="w-full md:w-64 bg-white border-r border-gray-200 p-6 flex flex-col">
            <div class="flex items-center justify-center gap-3 mb-10">
                <div class="bg-secondary-light p-2 rounded-lg">
                    <span class="font-display text-2xl font-bold text-secondary">LR</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 text-lifted">LocalRank</h1>
            </div>
            <nav class="flex-grow">
                <a href="#dashboard" class="nav-link active flex items-center gap-3 px-4 py-3 text-gray-700 font-bold bg-gray-100 rounded-lg">
                    <i data-lucide="bar-chart-3"></i> Dashboard
                </a>
                 <a href="#settings" class="nav-link mt-2 flex items-center gap-3 px-4 py-3 text-gray-500 hover:bg-gray-100 hover:text-gray-700 rounded-lg transition-colors">
                    <i data-lucide="settings"></i> Settings
                </a>
            </nav>
            <div class="mt-auto">
                 <div class="bg-secondary-light border border-sky-200 text-center p-6 rounded-xl">
                     <h4 class="font-bold text-lg text-gray-800">Upgrade Your Plan</h4>
                     <p class="text-sm text-gray-600 mt-2 mb-4">Unlock unlimited sites and advanced prospecting tools.</p>
                     <button class="w-full bg-secondary text-white font-bold py-2 px-4 rounded-lg hover:bg-opacity-90 transition-all">Upgrade Now</button>
                 </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 md:p-10">
            <div id="dashboard-view">
                <header class="text-center">
                    <h2 class="text-4xl font-bold text-gray-800 text-lifted">Dashboard</h2>
                    <p class="text-gray-500 mt-2">Create a new lead generation asset in minutes. Let's get real.</p>
                </header>

                <!-- Input Section -->
                <div class="mt-8 bg-white rounded-xl shadow-md p-6 border border-gray-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                        <div>
                            <label for="niche" class="block text-sm font-bold text-gray-700 mb-2">Service Niche</label>
                            <div class="relative">
                                <i data-lucide="briefcase" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size="20"></i>
                                <input id="niche" type="text" placeholder="e.g., Plumbing, Roofing" class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 ring-primary">
                            </div>
                        </div>
                         <div>
                            <label for="location" class="block text-sm font-bold text-gray-700 mb-2">Location</label>
                            <div class="relative">
                                <i data-lucide="map-pin" class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size="20"></i>
                                <input id="location" type="text" placeholder="e.g., Austin, TX" class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 ring-primary">
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 flex justify-end">
                        <button id="generate-btn" class="flex items-center justify-center gap-2 px-6 py-3 font-bold text-white btn-primary rounded-lg shadow-lg hover:bg-opacity-90 transform hover:-translate-y-0.5 transition-all duration-300 ease-in-out w-full md:w-auto">
                            <i data-lucide="zap"></i>
                            Generate Digital Asset
                        </button>
                    </div>
                </div>

                <!-- Initial Placeholder -->
                <div id="initial-placeholder" class="mt-10 text-center text-gray-500 bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-12">
                    <i data-lucide="mouse-pointer-square" class="mx-auto h-12 w-12 text-gray-400"></i>
                    <h3 class="mt-2 text-lg font-semibold text-gray-800">Your results will appear here</h3>
                    <p class="mt-1 text-sm">Enter a niche and location above, then click "Generate" to build your site, GMB content, and prospect list.</p>
                </div>


                <!-- Results Section -->
                <div id="results-container" class="mt-10 hidden">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="bg-gray-100 p-3 rounded-lg">
                            <i data-lucide="cpu" class="text-primary" size="28"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold">Your Asset is Ready</h3>
                            <p id="asset-title" class="text-gray-500 font-medium"></p>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="border-b border-gray-200">
                        <nav class="flex -mb-px" aria-label="Tabs">
                            <a href="#" data-tab="site" class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-primary border-primary">
                                AI-Generated Site
                            </a>
                            <a href="#" data-tab="gmb" class="tab-link whitespace-nowrap ml-8 py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                                GMB Optimization
                            </a>
                            <a href="#" data-tab="prospects" class="tab-link whitespace-nowrap ml-8 py-4 px-1 border-b-2 font-medium text-sm text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300">
                                Client Prospects
                            </a>
                        </nav>
                    </div>

                    <!-- Tab Content -->
                    <div id="tab-content" class="mt-6">
                        <!-- Site Generation Content -->
                        <div id="site-content" class="tab-pane">
                            <!-- This will be populated by JS -->
                        </div>
                        <!-- GMB Optimization Content -->
                        <div id="gmb-content" class="tab-pane hidden">
                             <!-- This will be populated by JS -->
                        </div>
                        <!-- Client Prospects Content -->
                        <div id="prospects-content" class="tab-pane hidden">
                             <!-- This will be populated by JS -->
                        </div>
                    </div>
                </div>

                 <!-- Loading Spinner -->
                <div id="loader" class="hidden text-center p-10">
                    <div role="status">
                        <svg aria-hidden="true" class="inline w-12 h-12 text-gray-200 animate-spin fill-primary" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                            <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                        </svg>
                        <p class="mt-4 text-lg font-semibold text-gray-600">Building your digital asset...</p>
                        <p class="text-sm text-gray-500">The AI is firing on all cylinders. This will just take a moment.</p>
                    </div>
                </div>
            </div>
            <div id="settings-view" class="hidden">
                 <h2 class="text-4xl font-bold text-gray-800">Settings</h2>
                 <p class="text-gray-500 mt-2">Manage your account and preferences.</p>
                 <div class="mt-8 bg-white rounded-xl shadow-md p-6 border border-gray-100">
                     <h3 class="font-bold text-xl">Coming Soon!</h3>
                     <p class="text-gray-600 mt-2">We're working on adding more customization options to your LocalRank Engine experience.</p>
                 </div>
            </div>
        </main>
    </div>

<script>
    // --- GEMINI API SETUP --- //
    const apiKey = ""; // Leave empty, handled by the environment
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

    async function callGeminiAPI(prompt, systemInstruction = "You are a helpful assistant.") {
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: {
                parts: [{ text: systemInstruction }]
            },
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                console.error("API Error Response:", await response.text());
                return `Error: Received status ${response.status}. Please check the console for details.`;
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                return candidate.content.parts[0].text;
            } else {
                console.error("Unexpected API response structure:", result);
                return "Error: Could not extract text from the API response.";
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            return "Error: An error occurred while contacting the API.";
        }
    }


    // --- MOCK DATA & HELPERS --- //
    const mockProspects = {
        'Plumbing|Austin, TX': [
            { name: 'Austin Flow Masters', website: 'flowmasters-austin.com', score: 45, reason: 'Outdated website, no recent GMB posts.' },
            { name: 'Leaky Pipes R Us', website: 'leakypipesaustin.net', score: 32, reason: 'Poor mobile experience, missing key service pages.' },
            { name: 'ATX Drain Services', website: 'atxdrain.com', score: 51, reason: 'Low review count, inconsistent NAP information.' },
        ],
        'Roofing|Miami, FL': [
            { name: 'Miami Roof Pros', website: 'miamiroofpro.com', score: 55, reason: 'No blog content, limited service area information.' },
            { name: 'Sunshine State Roofing', website: 'sunshineroof.miami', score: 41, reason: 'Slow page load speed, not HTTPS secured.' },
            { name: '305 Roof Repair', website: '305roofs.com', score: 38, reason: 'Thin content, no GMB profile claimed.' },
        ],
        'Landscaping|Denver, CO': [
            { name: 'Mile High Gardens', website: 'mhgardens.com', score: 62, reason: 'Good design but poor on-page SEO.' },
            { name: 'Denver Green Thumbs', website: 'denvergreenthumb.net', score: 48, reason: 'No clear call-to-action, few customer testimonials.' },
        ]
    };

    const generateOptimizationTips = () => [
        'Complete every section of your Google Business Profile.',
        'Add high-quality photos and videos regularly.',
        'Encourage customers to leave reviews and respond to all of them.',
        'Use Google Posts to share updates, offers, and events.',
        'Answer questions in the GMB Q&A section proactively.',
        'Ensure your business name, address, and phone number (NAP) are consistent everywhere online.',
    ];
    
    function formatAIResponse(text) {
        if (!text) return '';
        // Bolds text between asterisks, e.g., *word* -> <strong>word</strong>
        return text.replace(/\*(.*?)\*/g, '<strong>$1</strong>');
    }

    // --- DOM ELEMENTS --- //
    const generateBtn = document.getElementById('generate-btn');
    const nicheInput = document.getElementById('niche');
    const locationInput = document.getElementById('location');
    const loader = document.getElementById('loader');
    const resultsContainer = document.getElementById('results-container');
    const assetTitle = document.getElementById('asset-title');
    const initialPlaceholder = document.getElementById('initial-placeholder');
    
    const siteContent = document.getElementById('site-content');
    const gmbContent = document.getElementById('gmb-content');
    const prospectsContent = document.getElementById('prospects-content');
    
    const tabLinks = document.querySelectorAll('.tab-link');
    const tabPanes = document.querySelectorAll('.tab-pane');
    const navLinks = document.querySelectorAll('.nav-link');
    
    // --- APP LOGIC --- //
    document.addEventListener('DOMContentLoaded', () => {
        lucide.createIcons();
        
        generateBtn.addEventListener('click', handleGenerate);

        tabLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                handleTabClick(link.dataset.tab);
            });
        });

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);
                handleNavClick(targetId);

                navLinks.forEach(nav => nav.classList.remove('active', 'bg-gray-100', 'text-gray-700', 'font-bold'));
                navLinks.forEach(nav => nav.classList.add('text-gray-500'));
                link.classList.add('active', 'bg-gray-100', 'text-gray-700', 'font-bold');
                link.classList.remove('text-gray-500');
            });
        });
    });

    function handleNavClick(targetId) {
        document.getElementById('dashboard-view').classList.add('hidden');
        document.getElementById('settings-view').classList.add('hidden');

        if(document.getElementById(`${targetId}-view`)){
             document.getElementById(`${targetId}-view`).classList.remove('hidden');
        }
    }

    function handleTabClick(tab) {
        tabPanes.forEach(pane => pane.classList.add('hidden'));
        document.getElementById(`${tab}-content`).classList.remove('hidden');

        tabLinks.forEach(link => {
            link.classList.remove('text-primary', 'border-primary');
            link.classList.add('text-gray-500', 'border-transparent');
        });
        
        const activeLink = document.querySelector(`.tab-link[data-tab="${tab}"]`);
        activeLink.classList.add('text-primary', 'border-primary');
        activeLink.classList.remove('text-gray-500', 'border-transparent');
    }

    async function handleGenerate() {
        const niche = nicheInput.value.trim();
        const location = locationInput.value.trim();

        if (!niche || !location) {
            alert('Please provide both a niche and a location.');
            return;
        }

        initialPlaceholder.classList.add('hidden');
        resultsContainer.classList.add('hidden');
        loader.classList.remove('hidden');

        // This simulates initial asset creation, then we fetch AI content
        setTimeout(async () => {
            loader.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            assetTitle.textContent = `${niche} in ${location}`;
            
            renderSiteGenerator(niche, location);
            await renderGMBOptimization(niche, location);
            renderProspecting(niche, location);
            handleTabClick('site'); // Start on the site tab
        }, 1000);
    }

    function renderSiteGenerator(niche, location) {
        const domain = `${niche.replace(/\s+/g, '-')}-${location.split(',')[0].replace(/\s+/g, '')}.com`.toLowerCase();
        const pages = ['Home', 'About Us', `Emergency ${niche} Services`, 'Service Area', 'Blog', 'Contact Us'];
        siteContent.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white rounded-xl shadow-md p-6 border border-gray-100">
                    <h4 class="font-bold text-xl mb-1">Generated Website Preview</h4>
                    <p class="text-sm text-gray-500 mb-4">A fully-functional, SEO-optimized site is ready to deploy.</p>
                    <div class="aspect-video bg-gray-100 rounded-lg p-4 border border-gray-200">
                        <div class="h-full w-full bg-white rounded shadow-inner flex flex-col">
                            <header class="flex items-center justify-between p-2 border-b">
                                 <div class="flex items-center gap-1">
                                    <span class="w-3 h-3 bg-red-400 rounded-full"></span>
                                    <span class="w-3 h-3 bg-yellow-400 rounded-full"></span>
                                    <span class="w-3 h-3 bg-green-400 rounded-full"></span>
                                 </div>
                                 <div class="text-xs text-gray-500 bg-gray-200 px-4 py-1 rounded-full">${domain}</div>
                            </header>
                            <main class="flex-grow p-4">
                                <h1 class="font-display text-lg font-bold text-primary">Best ${niche} in ${location}</h1>
                                <p class="text-xs text-gray-600 mt-1">Your trusted local experts. Call now for a free quote!</p>
                                <div class="mt-3 w-3/4 h-2 bg-gray-200 rounded"></div>
                                <div class="mt-1 w-1/2 h-2 bg-gray-200 rounded"></div>
                            </main>
                        </div>
                    </div>
                     <div class="mt-6 p-4 border rounded-lg bg-gray-50">
                        <h5 class="font-bold text-lg">About Us Page Content</h5>
                        <p class="text-sm text-gray-500 mb-3">Use our AI to generate a compelling About Us page for your site.</p>
                        <div id="about-us-content" class="text-sm text-gray-700 bg-white p-3 rounded border border-gray-200 min-h-[100px]">Click the button to generate content.</div>
                        <button id="generate-about-us-btn" class="mt-3 flex items-center justify-center gap-2 text-sm px-4 py-2 font-bold text-white btn-secondary rounded-lg shadow-sm hover:bg-opacity-90 transition-all">
                            ✨ Generate 'About Us' with AI
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6 border border-gray-100">
                     <h4 class="font-bold text-xl mb-4">Site Details</h4>
                     <div class="space-y-4">
                        <div>
                            <p class="text-sm font-bold text-gray-600">Suggested Domain</p>
                            <p class="font-semibold text-gray-800">${domain}</p>
                        </div>
                         <div>
                            <p class="text-sm font-bold text-gray-600">Generated Pages</p>
                            <ul class="mt-1 space-y-1">
                                ${pages.map(page => `<li class="flex items-center gap-2 text-sm text-gray-700"><i data-lucide="check-circle" class="text-green-500" size="16"></i>${page}</li>`).join('')}
                            </ul>
                        </div>
                         <div>
                            <p class="text-sm font-bold text-gray-600">Features</p>
                            <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-green-100 text-green-800">SEO Optimized</span>
                            <span class="text-xs font-medium mr-2 px-2.5 py-0.5 rounded bg-blue-100 text-blue-800">Mobile Responsive</span>
                        </div>
                     </div>
                </div>
            </div>
        `;
        document.getElementById('generate-about-us-btn').addEventListener('click', async () => {
            const btn = document.getElementById('generate-about-us-btn');
            const contentDiv = document.getElementById('about-us-content');
            btn.innerHTML = `<i data-lucide="loader" class="spinner"></i> Generating...`;
            btn.disabled = true;
            lucide.createIcons();
            const prompt = `Write an "About Us" page for a local business website. The business type is "${niche}" and they are located in "${location}". The tone should be professional, trustworthy, and focused on customer service. Mention their commitment to the local community. Make it about 2-3 paragraphs long. Please bold important keywords or phrases by wrapping them in asterisks (*word*).`;
            const content = await callGeminiAPI(prompt, "You are an expert copywriter specializing in local service businesses.");
            contentDiv.innerHTML = formatAIResponse(content);
            btn.innerHTML = `✨ Regenerate with AI`;
            btn.disabled = false;
        });
        lucide.createIcons();
    }
    
    async function renderGMBOptimization(niche, location) {
        const tips = generateOptimizationTips();
        gmbContent.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                     <div class="flex justify-between items-center mb-4">
                        <h4 class="font-bold text-xl">AI-Suggested GMB Posts</h4>
                        <button id="regenerate-gmb-btn" class="text-sm flex items-center gap-1 font-bold text-secondary hover:text-opacity-80">
                            <i data-lucide="refresh-cw" size="16"></i>Suggest More Posts
                        </button>
                     </div>
                     <div id="gmb-posts-container" class="space-y-4">
                        <div class="text-center p-4 border rounded-lg bg-gray-50">Loading AI suggestions...</div>
                     </div>
                </div>
                 <div>
                     <h4 class="font-bold text-xl mb-4">Optimization Checklist</h4>
                     <ul class="space-y-3">
                        ${tips.map(tip => `
                            <li class="flex items-start gap-3">
                                <i data-lucide="check-square" class="text-secondary mt-1" size="18"></i>
                                <span class="text-gray-700">${tip}</span>
                            </li>
                        `).join('')}
                     </ul>
                </div>
            </div>
        `;

        const fetchAndRenderGMBPosts = async () => {
            const container = document.getElementById('gmb-posts-container');
            container.innerHTML = `<div class="text-center p-4 border rounded-lg bg-gray-50"><i data-lucide="loader" class="spinner inline-block"></i> Fetching new ideas...</div>`;
            lucide.createIcons();
            const prompt = `Generate 3 distinct Google Business Profile post ideas for a "${niche}" company in "${location}". For each post, provide a short, catchy title and the post content. The content should be engaging and include a call to action. Bold key phrases with asterisks (*word*). Format the output as a JSON array of objects, where each object has a "title" and "content" key.`;
            const responseText = await callGeminiAPI(prompt, "You are a Google Business Profile expert creating engaging social media posts.");
            
            try {
                // Clean the response to make it valid JSON
                const cleanedResponse = responseText.replace(/```json|```/g, '').trim();
                const posts = JSON.parse(cleanedResponse);
                container.innerHTML = posts.map(post => `
                    <div class="bg-white rounded-lg p-4 border">
                        <h5 class="font-bold">${post.title.replace(/\*/g, '')}</h5>
                        <p class="text-sm text-gray-600 mt-1">${formatAIResponse(post.content)}</p>
                    </div>
                `).join('');
            } catch (e) {
                console.error("Failed to parse GMB posts JSON:", e);
                container.innerHTML = `<div class="text-center p-4 border rounded-lg bg-red-50 text-red-700">Could not parse AI response. Please try again.</div>`;
            }
        };

        document.getElementById('regenerate-gmb-btn').addEventListener('click', fetchAndRenderGMBPosts);
        await fetchAndRenderGMBPosts(); // Initial fetch
        lucide.createIcons();
    }
    
    function renderProspecting(niche, location) {
        const key = `${niche}|${location}`;
        const prospects = mockProspects[key] || [];

        if (prospects.length === 0) {
            prospectsContent.innerHTML = `
                <div class="text-center bg-white p-8 rounded-lg border">
                    <h4 class="font-bold text-lg">No Obvious Prospects Found</h4>
                    <p class="text-gray-600 mt-2">The AI couldn't find ideal businesses with a poor online presence in this specific niche and location combination. Try a different search!</p>
                </div>`;
            return;
        }

        prospectsContent.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div id="prospects-list-container">
                     <h4 class="font-bold text-xl mb-4">Top Client Prospects</h4>
                     <div class="space-y-3">
                        ${prospects.map((p, index) => `
                            <div class="prospect-card bg-white p-4 rounded-lg border flex justify-between items-center cursor-pointer hover:border-primary" data-prospect-name="${p.name}" data-prospect-reason="${p.reason}">
                                <div>
                                    <p class="font-bold">${p.name}</p>
                                    <p class="text-sm text-gray-500">${p.reason}</p>
                                </div>
                                <div class="text-right">
                                     <p class="font-bold text-lg ${p.score < 50 ? 'text-red-500' : 'text-yellow-500'}">${p.score}</p>
                                     <p class="text-xs text-gray-400">Presence Score</p>
                                </div>
                            </div>
                        `).join('')}
                     </div>
                </div>
                <div id="email-draft-container" class="bg-white p-6 rounded-xl border shadow-md">
                    <div class="text-center text-gray-500 h-full flex flex-col justify-center items-center">
                        <i data-lucide="mail" size="40" class="mb-4"></i>
                        <h4 class="font-bold text-lg">Select a Prospect</h4>
                        <p>Click on a business to generate a ✨ personalized outreach email with AI.</p>
                    </div>
                </div>
            </div>`;
            
        document.querySelectorAll('.prospect-card').forEach(card => {
            card.addEventListener('click', async () => {
                document.querySelectorAll('.prospect-card').forEach(c => c.classList.remove('bg-secondary-light', 'border-primary'));
                card.classList.add('bg-secondary-light', 'border-primary');
                
                const prospectName = card.dataset.prospectName;
                const prospectReason = card.dataset.prospectReason;
                const emailContainer = document.getElementById('email-draft-container');

                emailContainer.innerHTML = `<div class="text-center p-4"><i data-lucide="loader" class="spinner inline-block"></i> Drafting personalized email...</div>`;
                lucide.createIcons();

                const prompt = `Write a personalized outreach email to a potential client.
                - My Name: A local marketing expert.
                - Client's Business Name: "${prospectName}"
                - Client's Niche: "${niche}"
                - Client's Location: "${location}"
                - Key Issue I identified: "${prospectReason}"
                
                The email should be concise, professional, and friendly. It should mention the specific issue I found and position my service (providing exclusive leads from a pre-built digital asset) as the solution. The goal is to get them to agree to a brief chat. Please bold key phrases for emphasis using asterisks (*word*).
                
                Format the response as a JSON object with two keys: "subject" and "body".`;
                
                const responseText = await callGeminiAPI(prompt, "You are a world-class sales copywriter specializing in B2B outreach for local businesses.");
                
                try {
                    const cleanedResponse = responseText.replace(/```json|```/g, '').trim();
                    const draft = JSON.parse(cleanedResponse);
                    const formattedSubject = draft.subject.replace(/\*/g, '');
                    const formattedBody = formatAIResponse(draft.body);

                    emailContainer.innerHTML = `
                        <h4 class="font-bold text-xl mb-4">✨ AI-Personalized Email Draft</h4>
                        <div>
                            <label class="text-sm font-bold text-gray-600">Subject</label>
                            <input type="text" readonly value="${formattedSubject}" class="mt-1 w-full p-2 bg-gray-100 rounded border">
                        </div>
                        <div class="mt-4">
                            <label class="text-sm font-bold text-gray-600">Body</label>
                            <div class="email-body-content mt-1 w-full p-2 bg-gray-100 rounded border h-64 resize-none overflow-y-auto">${formattedBody}</div>
                        </div>
                        <button onclick="copyToClipboard(this)" class="mt-4 w-full flex items-center justify-center gap-2 py-2 px-4 text-sm font-bold bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            <i data-lucide="copy" size="16"></i> Copy to Clipboard
                        </button>
                    `;
                } catch (e) {
                     emailContainer.innerHTML = `<div class="text-center p-4 border rounded-lg bg-red-50 text-red-700">Could not parse AI response. Please try again.</div>`;
                }
                
                lucide.createIcons();
            });
        });
        lucide.createIcons();
    }

    function copyToClipboard(button) {
        const container = button.parentElement;
        const subject = container.querySelector('input').value;
        const bodyEl = container.querySelector('.email-body-content');
        const body = bodyEl.innerText;
        const textToCopy = `Subject: ${subject}\n\n${body}`;
        
        // Using document.execCommand as a fallback for iframe environments
        const textArea = document.createElement("textarea");
        textArea.value = textToCopy;
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            button.innerHTML = `<i data-lucide="check" size="16"></i> Copied!`;
            setTimeout(() => {
                button.innerHTML = `<i data-lucide="copy" size="16"></i> Copy to Clipboard`;
                 lucide.createIcons();
            }, 2000);
        } catch (err) {
            console.error('Failed to copy: ', err);
            alert('Failed to copy email.');
        }
        document.body.removeChild(textArea);
        lucide.createIcons();
    }
</script>
</body>
</html>

